<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mineiro - Gerenciar Funcion√°rios na Nuvem</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 10px;
            background-color: #f0f0f0;
            box-sizing: border-box;
        }
        h1 {
            color: #333;
            text-align: center;
            font-size: 1.8rem;
        }
        .form-container, .search-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        input, select, button {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
            font-size: 1rem;
        }
        select {
            cursor: pointer;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            padding: 12px;
            min-height: 44px;
        }
        button:hover {
            background-color: #218838;
        }
        #listAllButton {
            background-color: #007bff;
            width: auto;
            min-width: 120px;
        }
        #listAllButton:hover {
            background-color: #0056b3;
        }
        #cancelEditButton {
            background-color: #6c757d;
            margin-top: 5px;
        }
        #cancelEditButton:hover {
            background-color: #5a6268;
        }
        .search-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        #employeeList {
            list-style: none;
            padding: 0;
        }
        #employeeList li {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-size: 0.9rem;
            word-break: break-word;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        #employeeList li .employee-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }
        #employeeList li .employee-name {
            margin-right: 10px;
            font-weight: bold;
        }
        #employeeList li .employee-id-role {
            margin-left: 5px;
            color: #666;
        }
        #employeeList li:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s;
        }
        #employeeList li.selected {
            background-color: #e8f4ff !important;
            border: 2px solid #007bff !important;
        }
        .delete-icon {
            color: #dc3545;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 2px 5px;
        }
        .delete-icon:hover {
            color: #c82333;
        }
        #employeeCounter {
            text-align: center;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        @media (max-width: 600px) {
            body {
                margin: 10px;
                padding: 5px;
            }
            h1 {
                font-size: 1.5rem;
            }
            .form-container, .search-container {
                padding: 10px;
            }
            input, select, button {
                font-size: 0.9rem;
                padding: 8px;
            }
            #listAllButton, #cancelEditButton {
                min-width: 100px;
                padding: 8px;
            }
            #employeeList li {
                font-size: 0.85rem;
                padding: 8px;
            }
            #employeeCounter {
                font-size: 0.9rem;
            }
        }
        @media (max-width: 400px) {
            h1 {
                font-size: 1.2rem;
            }
            input, select, button {
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <h1>MemoBuddy - Teus Funcion√°rios na Nuvem! ‚òÅÔ∏èüòé</h1>
   
    <div class="form-container">
        <h3 id="formTitle">Adicionar Funcion√°rio</h3>
        <input type="text" id="employeeName" placeholder="Nome do funcion√°rio">
        <input type="text" id="employeeId" placeholder="Matr√≠cula">
        <select id="employeeRole">
            <option value="" disabled selected>Selecione o cargo</option>
            <option value="Coletor">Coletor</option>
            <option value="Gari">Gari</option>
            <option value="Motorista">Motorista</option>
        </select>
        <button id="formButton" onclick="saveEmployee()">Salvar na Nuvem</button>
        <button id="cancelEditButton" style="display: none;" onclick="cancelEdit()">Cancelar</button>
    </div>
   
    <div class="search-container">
        <h3>Procurar Funcion√°rio</h3>
        <input type="text" id="searchInput" placeholder="Digite nome, matr√≠cula ou cargo" onkeyup="searchEmployees()">
        <button id="listAllButton" onclick="listAllEmployees()">Listar Todos</button>
    </div>
   
    <p id="employeeCounter">Total de funcion√°rios na nuvem: 0 ‚òÅÔ∏è</p>
    <ul id="employeeList"></ul>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
   
    <script>
        // Configura√ß√£o do teu projeto Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC35sX_nm4lX4oa1tpNSuZTee-kcb0Dsfk",
            authDomain: "memobuddy-8aa1d.firebaseapp.com",
            projectId: "memobuddy-8aa1d",
            storageBucket: "memobuddy-8aa1d.appspot.com",
            messagingSenderId: "43382520454",
            appId: "1:43382520454:web:1bdabfb207240291906f07"
        };
        // Inicializa o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // Estado pra rastrear edi√ß√£o
        let editingEmployeeId = null;
        // Fun√ß√£o pra verificar matr√≠cula duplicada
        async function checkDuplicateEmployeeId(employeeId, excludeDocId = null) {
            try {
                const querySnapshot = await db.collection('employees')
                    .where('employeeId', '==', employeeId)
                    .get();
                if (excludeDocId) {
                    return querySnapshot.docs.some(doc => doc.id !== excludeDocId);
                }
                return !querySnapshot.empty;
            } catch (error) {
                console.error('Erro ao verificar matr√≠cula:', error);
                return false;
            }
        }
        // Fun√ß√£o pra verificar nome duplicado
        async function checkDuplicateEmployeeName(name, excludeDocId = null) {
            try {
                const querySnapshot = await db.collection('employees')
                    .where('name', '==', name.toUpperCase())
                    .get();
                if (excludeDocId) {
                    return querySnapshot.docs.some(doc => doc.id !== excludeDocId);
                }
                return !querySnapshot.empty;
            } catch (error) {
                console.error('Erro ao verificar nome:', error);
                return false;
            }
        }
        // Fun√ß√£o pra adicionar ou editar funcion√°rio
        async function saveEmployee() {
            let name = document.getElementById('employeeName').value.trim().toUpperCase();
            let employeeId = document.getElementById('employeeId').value.trim();
            let role = document.getElementById('employeeRole').value;
            if (name && employeeId && role) {
                try {
                    // Verifica matr√≠cula duplicada
                    const isDuplicateId = await checkDuplicateEmployeeId(employeeId, editingEmployeeId);
                    if (isDuplicateId) {
                        alert('Opa, essa matr√≠cula j√° t√° cadastrada! Tenta outra, campe√£o! üòú');
                        return;
                    }
                    // Verifica nome duplicado
                    const isDuplicateName = await checkDuplicateEmployeeName(name, editingEmployeeId);
                    if (isDuplicateName) {
                        alert('Opa, esse nome j√° t√° cadastrado! Tenta outro, campe√£o! üòú');
                        return;
                    }
                    if (editingEmployeeId) {
                        // Edita funcion√°rio existente
                        await db.collection('employees').doc(editingEmployeeId).update({
                            name: name,
                            employeeId: employeeId,
                            role: role,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Funcion√°rio atualizado na nuvem! T√° voando alto! üöÄ');
                    } else {
                        // Adiciona novo funcion√°rio
                        await db.collection('employees').add({
                            name: name,
                            employeeId: employeeId,
                            role: role,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Funcion√°rio salvo na nuvem! T√° voando alto! üöÄ');
                    }
                    // Reseta o formul√°rio
                    cancelEdit();
                    loadEmployees();
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    alert('Opa, algo deu errado! Erro: ' + error.message);
                }
            } else {
                alert('Preenche todos os campos, campe√£o! N√£o deixa a nuvem vazia! üòú');
            }
        }
        // Fun√ß√£o pra cancelar edi√ß√£o
        function cancelEdit() {
            editingEmployeeId = null;
            document.getElementById('formTitle').textContent = 'Adicionar Funcion√°rio';
            document.getElementById('formButton').textContent = 'Salvar na Nuvem';
            document.getElementById('cancelEditButton').style.display = 'none';
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeRole').value = '';
            // Remove destaque de qualquer item selecionado
            document.querySelectorAll('#employeeList li').forEach(item => {
                item.style.backgroundColor = 'white';
                item.style.border = 'none';
                item.classList.remove('selected');
            });
        }
        // Fun√ß√£o pra iniciar edi√ß√£o
        function editEmployee(employee) {
            editingEmployeeId = employee.id;
            document.getElementById('formTitle').textContent = 'Editar Funcion√°rio';
            document.getElementById('formButton').textContent = 'Atualizar';
            document.getElementById('cancelEditButton').style.display = 'block';
            document.getElementById('employeeName').value = employee.name || '';
            document.getElementById('employeeId').value = employee.employeeId || '';
            document.getElementById('employeeRole').value = employee.role || '';
            // Foco no campo de nome pra facilitar
            document.getElementById('employeeName').focus();
        }
        // Fun√ß√£o pra apagar funcion√°rio
        async function deleteEmployee(employeeId, employeeName) {
            if (confirm(`Tem certeza que deseja apagar ${employeeName}? Essa a√ß√£o n√£o pode ser desfeita!`)) {
                try {
                    await db.collection('employees').doc(employeeId).delete();
                    alert('Funcion√°rio removido da nuvem! üò¢');
                    loadEmployees();
                } catch (error) {
                    console.error('Erro ao apagar funcion√°rio:', error);
                    alert('Opa, algo deu errado ao apagar! Erro: ' + error.message);
                }
            }
        }
        // Fun√ß√£o pra obter o √≠cone do cargo
        function getRoleIcon(role) {
            switch (role) {
                case 'Gari': return 'üßπ';
                case 'Motorista': return 'üöõ';
                case 'Coletor': return 'üóëÔ∏è';
                default: return '';
            }
        }
        // Fun√ß√£o pra carregar e mostrar funcion√°rios
        async function loadEmployees(query = '') {
            try {
                console.log('Iniciando busca com query:', query);
                let ul = document.getElementById('employeeList');
                let counter = document.getElementById('employeeCounter');
                ul.innerHTML = '';
                // Consulta sem ordena√ß√£o no Firestore
                let q = db.collection('employees');
                let snapshot = await q.get();
                console.log('Documentos encontrados:', snapshot.size);
                let employees = [];
                snapshot.forEach(doc => {
                    let employee = doc.data();
                    console.log('Documento bruto:', { id: doc.id, ...employee });
                    // Verifica se os campos existem e s√£o v√°lidos
                    if (!employee.employeeId || !employee.name || !employee.role) {
                        console.warn(`Documento ${doc.id} possui campos ausentes ou inv√°lidos:`, employee);
                        return;
                    }
                    let firstName = (employee.name || '').split(' ')[0]?.toLowerCase() || '';
                    if (
                        query === '' ||
                        employee.employeeId.toLowerCase().includes(query.toLowerCase()) ||
                        firstName.startsWith(query.toLowerCase()) ||
                        employee.role.toLowerCase().includes(query.toLowerCase())
                    ) {
                        employees.push({
                            id: doc.id,
                            name: employee.name,
                            employeeId: employee.employeeId,
                            role: employee.role
                        });
                    }
                });
                // Ordena por employeeId em ordem crescente
                employees.sort((a, b) => {
                    const idA = a.employeeId || '';
                    const idB = b.employeeId || '';
                    // Converte para string e remove zeros √† esquerda para ordena√ß√£o num√©rica, se aplic√°vel
                    const numIdA = idA.replace(/^0+/, '');
                    const numIdB = idB.replace(/^0+/, '');
                    return numIdA.localeCompare(numIdB);
                });
                console.log('Funcion√°rios ordenados por matr√≠cula:', employees.map(e => `${e.employeeId} - ${e.name}`));
                counter.textContent = `Total de funcion√°rios na nuvem: ${employees.length} ‚òÅÔ∏è`;
                if (employees.length === 0) {
                    ul.innerHTML = '<li>Nenhum funcion√°rio encontrado. Tenta de novo! üòÖ</li>';
                } else {
                    employees.forEach(employee => {
                        let li = document.createElement('li');
                        let infoDiv = document.createElement('div');
                        infoDiv.className = 'employee-info';
                        infoDiv.innerHTML = `${getRoleIcon(employee.role)} <span class="employee-name">${employee.name}</span> <span class="employee-id-role">-${employee.employeeId} - ${employee.role}</span>`;
                        // Adiciona √≠cone de apagar
                        let deleteIcon = document.createElement('span');
                        deleteIcon.textContent = 'üóëÔ∏è';
                        deleteIcon.className = 'delete-icon';
                        deleteIcon.onclick = (e) => {
                            e.stopPropagation(); // Impede que o clique no √≠cone ative a edi√ß√£o
                            deleteEmployee(employee.id, employee.name);
                        };
                        li.appendChild(infoDiv);
                        li.appendChild(deleteIcon);
                        li.onclick = (e) => {
                            if (e.target !== deleteIcon) { // Evita edi√ß√£o ao clicar no √≠cone de apagar
                                // Remove destaque de outros itens
                                document.querySelectorAll('#employeeList li').forEach(item => {
                                    item.style.backgroundColor = 'white';
                                    item.style.border = 'none';
                                    item.classList.remove('selected');
                                });
                                // Adiciona destaque ao item clicado
                                li.style.backgroundColor = '#e8f4ff';
                                li.style.border = '2px solid #007bff';
                                li.classList.add('selected');
                                // Chama a fun√ß√£o de edi√ß√£o
                                editEmployee(employee);
                                // Rola pro formul√°rio
                                document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
                            }
                        };
                        ul.appendChild(li);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar lista:', error);
                let errorMessage = error.message || 'Erro desconhecido';
                if (error.code === 'failed-precondition') {
                    errorMessage = '√çndice do Firestore ausente. Acesse o Firebase Console e crie um √≠ndice composto para employees com employeeId (asc).';
                }
                alert('Erro ao carregar a lista: ' + errorMessage);
            }
        }
        // Fun√ß√£o pra buscar funcion√°rios
        function searchEmployees() {
            let query = document.getElementById('searchInput').value.trim();
            console.log('Evento de busca disparado com:', query);
            loadEmployees(query);
        }
        // Fun√ß√£o pra listar todos os funcion√°rios
        function listAllEmployees() {
            document.getElementById('searchInput').value = '';
            console.log('Listando todos os funcion√°rios');
            loadEmployees('');
        }
        // Carrega a lista ao abrir a p√°gina
        loadEmployees();
    </script>
</body>
</html>
